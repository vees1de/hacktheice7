// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  moduleFormat = "esm"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserStatus {
  PENDING     /// Ожидает завершения регистрации
  ACTIVE      /// Активен и может пользоваться системой
  INACTIVE    /// Деактивирован пользователем
  SUSPENDED   /// Временная блокировка (модерация, жалобы)
  REJECTED    /// Регистрация отклонена
  BLOCKED     /// Полная блокировка
}

enum OnboardingStep {
  SMS_VERIFICATION
  ESIA_AUTH
  PROFILE_SETUP
  COMPLETE
}

enum BeneficiaryCategoryType {
  PENSIONER
  DISABLED_1
  DISABLED_2
  DISABLED_3
  MULTICHILD_PARENT
  VETERAN
  LOW_INCOME
  STUDENT
  DISABLED_CHILD_PARENT
  RESIDENTS_NORTH_REGIONS
}

enum StaffRole {
  MANAGER
  ADMIN
  PARTNER
}

model User {
  id            String    @id @default(cuid())
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")
  
  email         String?    
  passwordHash  String
  authProvider  String    @default("email") 
  isVerified    Boolean   @default(false)
  isEsiaVerified Boolean   @default(false)
  
  firstName     String    
  lastName      String  
  patronymic    String?  
  dateOfBirth   DateTime  @map("date_of_birth") 
  phone         String    @unique 
  snils         String?   
  consentGiven  Boolean   @default(false) 
  consentDate   DateTime? @map("consent_date")

  region        Region    @relation(fields: [regionId], references: [id])
  regionId      String    @map("region_id")
  
  status        UserStatus @default(PENDING)
  onboardingStep OnboardingStep? @default(SMS_VERIFICATION)
  
  userBeneficiaryCategories UserBeneficiaryCategory[]
  
  preferences   UserPreference?
  benefitStatus UserBenefitStatus[]
  hiddenBenefits HiddenBenefit[]
  savedOffers   SavedOffer[]
  webauthnCredentials WebAuthnCredential[]
  
  staffProfile  Staff?
  authTokens    AuthToken[]
  
  verificationCode String? // Код подтверждения телефона
  
  @@map("user")
}

model Staff {
  id        String    @id @default(cuid())
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")

  role   StaffRole
  user   User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String    @unique @map("user_id")

  offers Offer[]   @relation("StaffOffers")

  @@map("staff")
}

model AuthToken {
  id        String   @id @default(cuid())
  token     String   @unique
  type      String   // "confirmation", "reset_password", "session"
  expiresAt DateTime
  used      Boolean  @default(false)

  user      User     @relation(fields: [userId], references: [id])
  userId    String   @map("user_id")

  createdAt DateTime @default(now()) @map("created_at")

  @@map("auth_token")
}

model RegistrationRequest {
  id               String   @id @default(cuid())
  phone            String   @unique
  verificationCode String
  data             Json
  expiresAt        DateTime
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  @@map("registration_request")
}

model Region {
  id        String  @id @default(cuid())
  name      String  @unique 
  code      String  @unique 
  type      String 
  
  users     User[]

  benefitRegions BenefitRegion[]
  offerRegions OfferRegion[]
  
  @@map("region")
}

model BeneficiaryCategory {
  id        String  @id @default(cuid())
  name      BeneficiaryCategoryType @unique // Используем enum для категорий
  title     String  // Человекочитаемое название: "Пенсионер", "Инвалид 1 группы" и т.д.
  icon      String? // Путь к иконке категории

  userCategories UserBeneficiaryCategory[]
  benefitCategories BenefitBeneficiaryCategory[]
  offerCategories OfferBeneficiaryCategory[]
  
  @@map("beneficiary_category")
}

model UserBeneficiaryCategory {
  user              User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId            String
  beneficiaryCategory BeneficiaryCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  categoryId        String
  
  confirmed         Boolean           @default(false) 
  confirmationDate  DateTime?         @map("confirmation_date")
  
  @@id([userId, categoryId])
  @@map("user_beneficiary_category")
}

model Benefit {
  id          String   @id @default(cuid())
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  
  title       String
  description String?
  type        String  
  validFrom   DateTime @map("valid_from")
  validTo     DateTime @map("valid_to")
  
  requirements String  
  howToGet    String   // Инструкция по получению
  sourceUrl   String?  @map("source_url") // Официальный источник
  
  // Прямые связи через промежуточные таблицы
  benefitRegions BenefitRegion[]
  benefitCategories BenefitBeneficiaryCategory[]
  
  status      UserBenefitStatus[]
  userHidden  HiddenBenefit[]
  
  @@map("benefit")
}

// Промежуточная таблица для связи многие-ко-многим Benefit-Region
model BenefitRegion {
  benefit   Benefit @relation(fields: [benefitId], references: [id], onDelete: Cascade)
  benefitId String
  region    Region   @relation(fields: [regionId], references: [id], onDelete: Cascade)
  regionId  String
  
  @@id([benefitId, regionId])
  @@map("benefit_region")
}

// Промежуточная таблица для связи многие-ко-многим Benefit-BeneficiaryCategory
model BenefitBeneficiaryCategory {
  benefit             Benefit             @relation(fields: [benefitId], references: [id], onDelete: Cascade)
  benefitId           String
  beneficiaryCategory BeneficiaryCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  categoryId          String
  
  @@id([benefitId, categoryId])
  @@map("benefit_beneficiary_category")
}

model Offer {
  id          String   @id @default(cuid())
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  
  title       String
  description String?
  partnerName String   @map("partner_name")
  partnerLogo String?  @map("partner_logo")
  discount    String   // Описание скидки: "10%", "Фиксированная скидка 100 рублей" и т.д.
  validFrom   DateTime @map("valid_from")
  validTo     DateTime @map("valid_to")
  terms       String   // Условия использования предложения
  
  link        String?  // Ссылка на партнера или детали предложения
  
  // Прямые связи через промежуточные таблицы
  offerRegions OfferRegion[]
  offerCategories OfferBeneficiaryCategory[]

  createdByStaff   Staff?   @relation("StaffOffers", fields: [createdByStaffId], references: [id])
  createdByStaffId String?  @map("created_by_staff_id")
  
  savedByUsers SavedOffer[]
  
  @@map("offer")
}

// Промежуточная таблица для связи многие-ко-многим Offer-Region
model OfferRegion {
  offer     Offer   @relation(fields: [offerId], references: [id], onDelete: Cascade)
  offerId   String
  region    Region  @relation(fields: [regionId], references: [id], onDelete: Cascade)
  regionId  String
  
  @@id([offerId, regionId])
  @@map("offer_region")
}

// Промежуточная таблица для связи многие-ко-многим Offer-BeneficiaryCategory
model OfferBeneficiaryCategory {
  offer               Offer               @relation(fields: [offerId], references: [id], onDelete: Cascade)
  offerId             String
  beneficiaryCategory BeneficiaryCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  categoryId          String
  
  @@id([offerId, categoryId])
  @@map("offer_beneficiary_category")
}

model UserBenefitStatus {
  id        String   @id @default(cuid())
  status    String   @default("active") // "active", "expired", "needs_confirmation"
  startDate DateTime @default(now()) @map("start_date")
  endDate   DateTime? @map("end_date")
  notes     String?
  
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    String   @map("user_id")
  benefit   Benefit  @relation(fields: [benefitId], references: [id], onDelete: Cascade)
  benefitId String   @map("benefit_id")
  
  @@unique([userId, benefitId])
  @@map("user_benefit_status")
}

model HiddenBenefit {
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    String
  benefit   Benefit  @relation(fields: [benefitId], references: [id], onDelete: Cascade)
  benefitId String
  
  @@id([userId, benefitId])
  @@map("hidden_benefit")
}

model SavedOffer {
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    String
  offer     Offer    @relation(fields: [offerId], references: [id], onDelete: Cascade)
  offerId   String
  
  savedAt   DateTime @default(now()) @map("saved_at")
  
  @@id([userId, offerId])
  @@map("saved_offer")
}

model UserPreference {
  id                String   @id @default(cuid())
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")
  
  notificationEmail Boolean  @default(true)
  notificationPush  Boolean  @default(true)
  showExpired       Boolean  @default(false)
  
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId            String   @unique @map("user_id")
  
  interestedCategories String[] // JSON массив категорий, интересующих пользователя
  preferredRegions    String[] // JSON массив предпочитаемых регионов
  
  @@map("user_preference")
}

model WebAuthnCredential {
  id          String   @id @default(cuid())
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  credentialId String  @unique
  publicKey   String
  counter     Int
  deviceType  String
  backedUp    Boolean  @default(false)
  transports  String[] @default([])

  user     User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId   String @map("user_id")

  @@map("webauthn_credential")
}
